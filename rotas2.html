<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotas Seguras - Etapa 2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
    <style>
        body {
            font-family: Arial;
            background-color: #0F171C;
            color: white;
            text-align: center;
            margin: 0;
        }

        h2 {
            background-color: #122026;
            padding: 10px;
        }

        #map {
            height: 400px;
            width: 90%;
            margin: 15px auto;
            border-radius: 12px;
        }

        button {
            width: 90%;
            margin: 5px auto;
            display: block;
            border: none;
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-size: 15px;
            cursor: pointer;
        }

        .acidente {
            background-color: #B22222;
        }

        .arvore {
            background-color: #C8B400;
            color: black;
        }

        .seguro {
            background-color: #1E90FF;
        }

        .confirmar {
            background-color: #780C28;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>

<body>

    <h2>Rotas Seguras</h2>

    <button class="acidente" onclick="mostrarRota('acidente')">üö® Acidente em andamento</button>
    <button class="arvore" onclick="mostrarRota('arvore')">üå≥ √Årvore no caminho</button>
    <button class="seguro" onclick="mostrarRota('seguro')">üõ£Ô∏è Caminho seguro</button>

    <div id="map"></div>

    <button id="btnConfirmar" class="confirmar" onclick="confirmarRota()">Confirmar rota</button>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>

        let map = L.map('map').setView([-23.3103, -51.1628], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        const origem = JSON.parse(localStorage.getItem("origem"));
        const destinoBase = JSON.parse(localStorage.getItem("destino"));
        let rotaAtual = null;
        let routeLayer = null;

        // Adiciona marcador de origem se os dados existirem
        if (origem) {
            L.marker(origem).addTo(map).bindPopup("Origem").openPopup();
        }

        // Adiciona marcador de destino se os dados existirem
        if (destinoBase) {
            L.marker(destinoBase).addTo(map).bindPopup("Destino Base").openPopup();
            // Ajusta o mapa para incluir origem e destino
            if (origem) {
                map.fitBounds([origem, destinoBase], { padding: [50, 50] });
            } else {
                map.setView(destinoBase, 15);
            }
        }


        function mostrarRota(tipo) {
            if (routeLayer) map.removeLayer(routeLayer);

            // deslocamentos diferentes simulando rotas alternativas
            let destino = [...destinoBase];
            let corLinha = "";

            if (tipo === "acidente") {
                destino[1] += 0.003;
                corLinha = "red";
            } else if (tipo === "arvore") {
                destino[0] -= 0.003;
                corLinha = "orange";
            } else if (tipo === "seguro") {
                corLinha = "blue";
            }


            rotaAtual = { tipo, origem, destino };

            const url = `https://router.project-osrm.org/route/v1/driving/${origem[1]},${origem[0]};${destino[1]},${destino[0]}?overview=full&geometries=geojson`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    const route = data.routes[0];
                    const line = L.geoJSON(route.geometry, {
                        style: { color: corLinha, weight: 5 }
                    }).addTo(map);
                    routeLayer = line;
                    map.fitBounds(line.getBounds(), { padding: [50, 50] });
                    document.getElementById("btnConfirmar").style.display = "block";
                })
                .catch(err => {
                    alert("Erro ao carregar rota. Verifique a conex√£o ou coordenadas.");
                    console.error(err);
                });
        }

        function confirmarRota() {
            if (!rotaAtual) return alert("Escolha uma rota primeiro!");
            localStorage.setItem("rotaSelecionada", JSON.stringify([rotaAtual.origem, rotaAtual.destino]));
            window.location.href = "rotas3.html"; // CORRIGIDO: rotas3.html
        }
    </script>

</body>

</html>